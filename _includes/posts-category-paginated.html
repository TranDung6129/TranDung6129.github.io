{% comment %} Category Posts with JavaScript Pagination {% endcomment %}
{% assign posts = site.posts | where_exp: "post", "post.categories contains include.taxonomy" | where_exp: "post", "post.hidden != true" %}
{% assign per_page = include.per_page | default: 5 %}
{% assign total_posts = posts.size %}

<div id="category-posts-container" data-per-page="{{ per_page }}" data-total-posts="{{ total_posts }}">
  {% for post in posts %}
    <div class="category-post-item" data-index="{{ forloop.index0 }}">
      {% include archive-single.html %}
    </div>
  {% endfor %}
</div>

{% if total_posts > per_page %}
  <nav class="pagination" id="category-pagination">
    <ul id="category-pagination-list">
      <!-- Pagination will be generated by JavaScript -->
    </ul>
  </nav>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('category-posts-container');
  const pagination = document.getElementById('category-pagination');
  const paginationList = document.getElementById('category-pagination-list');
  
  if (!container) return;
  
  // Mark container as JavaScript enabled
  container.classList.add('js-enabled');
  
  const perPage = parseInt(container.dataset.perPage);
  const totalPosts = parseInt(container.dataset.totalPosts);
  const totalPages = Math.ceil(totalPosts / perPage);
  const posts = container.querySelectorAll('.category-post-item');
  
  let currentPage = 1;
  
  // Get page from URL hash
  const hash = window.location.hash;
  if (hash && hash.startsWith('#page-')) {
    const pageFromHash = parseInt(hash.replace('#page-', ''));
    if (pageFromHash >= 1 && pageFromHash <= totalPages) {
      currentPage = pageFromHash;
    }
  }
  
  function showPage(page) {
    // Hide all posts
    posts.forEach(post => {
      post.style.display = 'none';
    });
    
    // Show posts for current page
    const startIndex = (page - 1) * perPage;
    const endIndex = Math.min(startIndex + perPage, totalPosts);
    
    for (let i = startIndex; i < endIndex; i++) {
      if (posts[i]) {
        posts[i].style.display = 'block';
      }
    }
    
    // Update URL hash
    if (page === 1) {
      history.replaceState(null, null, window.location.pathname);
    } else {
      history.replaceState(null, null, window.location.pathname + '#page-' + page);
    }
    
    updatePagination(page);
  }
  
  function updatePagination(page) {
    if (totalPages <= 1) {
      if (pagination) pagination.style.display = 'none';
      return;
    }
    
    let html = '';
    
    // Previous button
    if (page > 1) {
      html += `<li><a href="#page-${page - 1}" onclick="showCategoryPage(${page - 1}); return false;">Trước</a></li>`;
    } else {
      html += '<li><a href="#" class="disabled"><span aria-hidden="true">Trước</span></a></li>';
    }
    
    // Page numbers
    const maxButtons = 7; // Total buttons to show
    let startPage = Math.max(1, page - 2);
    let endPage = Math.min(totalPages, page + 2);
    
    // Adjust range if we're near the beginning or end
    if (endPage - startPage < 4) {
      if (startPage === 1) {
        endPage = Math.min(totalPages, startPage + 4);
      } else if (endPage === totalPages) {
        startPage = Math.max(1, endPage - 4);
      }
    }
    
    // First page and ellipsis
    if (startPage > 1) {
      html += `<li><a href="#page-1" onclick="showCategoryPage(1); return false;">1</a></li>`;
      if (startPage > 2) {
        html += '<li><a href="#" class="disabled">&hellip;</a></li>';
      }
    }
    
    // Page numbers in range
    for (let i = startPage; i <= endPage; i++) {
      if (i === page) {
        html += `<li><a href="#" class="disabled current">${i}</a></li>`;
      } else {
        html += `<li><a href="#page-${i}" onclick="showCategoryPage(${i}); return false;">${i}</a></li>`;
      }
    }
    
    // Last page and ellipsis
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += '<li><a href="#" class="disabled">&hellip;</a></li>';
      }
      html += `<li><a href="#page-${totalPages}" onclick="showCategoryPage(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    if (page < totalPages) {
      html += `<li><a href="#page-${page + 1}" onclick="showCategoryPage(${page + 1}); return false;">Sau</a></li>`;
    } else {
      html += '<li><a href="#" class="disabled"><span aria-hidden="true">Sau</span></a></li>';
    }
    
    paginationList.innerHTML = html;
  }
  
  // Global function for onclick handlers
  window.showCategoryPage = function(page) {
    currentPage = page;
    showPage(page);
    
    // Scroll to top of posts container
    container.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
  };
  
  // Handle browser back/forward
  window.addEventListener('hashchange', function() {
    const hash = window.location.hash;
    if (hash && hash.startsWith('#page-')) {
      const pageFromHash = parseInt(hash.replace('#page-', ''));
      if (pageFromHash >= 1 && pageFromHash <= totalPages) {
        currentPage = pageFromHash;
        showPage(currentPage);
      }
    } else if (!hash) {
      currentPage = 1;
      showPage(1);
    }
  });
  
  // Initialize
  showPage(currentPage);
});
</script> 